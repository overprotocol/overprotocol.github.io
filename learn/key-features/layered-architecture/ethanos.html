<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-learn/key-features/layered-architecture/ethanos" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Ethanos | OverProtocol Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://overprotocol.github.io/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://overprotocol.github.io/img/social-card.png"><meta data-rh="true" property="og:url" content="https://overprotocol.github.io/learn/key-features/layered-architecture/ethanos"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Ethanos | OverProtocol Docs"><meta data-rh="true" name="description" content="Ethanos is an effective mechanism for managing blockchain&#x27;s state and history. It periodically resets the state, expiring old data and referencing previous cycles to manage a bounded state size."><meta data-rh="true" property="og:description" content="Ethanos is an effective mechanism for managing blockchain&#x27;s state and history. It periodically resets the state, expiring old data and referencing previous cycles to manage a bounded state size."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://overprotocol.github.io/learn/key-features/layered-architecture/ethanos"><link data-rh="true" rel="alternate" href="https://overprotocol.github.io/learn/key-features/layered-architecture/ethanos" hreflang="en"><link data-rh="true" rel="alternate" href="https://overprotocol.github.io/learn/key-features/layered-architecture/ethanos" hreflang="x-default"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.daa76ebc.css">
<link rel="preload" href="/assets/js/runtime~main.8273acfe.js" as="script">
<link rel="preload" href="/assets/js/main.a4e6c244.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Over-Logo_black.png" alt="Over Logo" class="themedImage_ToTc themedImage--light_HNdA header-logo"><img src="/img/Over-Logo_black.png" alt="Over Logo" class="themedImage_ToTc themedImage--dark_i4oU header-logo"></div><b class="navbar__title text--truncate">OverProtocol</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/learn">Learn</a><a class="navbar__item navbar__link" href="/operators">Operators</a><a class="navbar__item navbar__link" href="/developers">Developers</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/">Canary ðŸš§</a><a href="https://www.github.com/overprotocol" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 sidebar-title">Learn</li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learn">What is OverProtocol</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/learn/key-features/layered-architecture/overview">Key Features</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/learn/key-features/layered-architecture/overview">Layered Architecture</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/learn/key-features/layered-architecture/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/learn/key-features/layered-architecture/ethanos">Ethanos</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/learn/key-features/over-pos/overview">Consensus</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/learn/key-features/tokenomics/overview">Tokenomics</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Key Features</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Layered Architecture</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Ethanos</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Ethanos</h1></header><p>Ethanos is an effective mechanism for managing blockchain&#x27;s state and history. It periodically resets the state, expiring old data and referencing previous cycles to manage a bounded state size. This approach lowers entry barriers, promotes decentralization, and fosters an inclusive blockchain system.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-the-problem">What is the Problem?<a href="#what-is-the-problem" class="hash-link" aria-label="Direct link to What is the Problem?" title="Direct link to What is the Problem?">â€‹</a></h2><p>It is essential to address the ever-increasing data size issue in blockchain systems. The account-based blockchain system, which records the global state of accounts and balances separately from transactions, offers a simpler and more intuitive framework for developing smart contracts. These tiny Turing-complete programs execute specific tasks using account states when triggered by transactions, and their integrity is verified by every node in the blockchain.</p><p>Typically, as time progresses, the number of accounts and transactions in any blockchain grows, leading to an infinite increase in state and history data. This growth in data size results in higher memory usage, more disk operations, and significant performance burdens. Consequently, this also creates substantial barriers for new participants attempting to synchronize and engage with the blockchain system.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-ethanos-works">How Ethanos Works<a href="#how-ethanos-works" class="hash-link" aria-label="Direct link to How Ethanos Works" title="Direct link to How Ethanos Works">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="differentiating-states">Differentiating States<a href="#differentiating-states" class="hash-link" aria-label="Direct link to Differentiating States" title="Direct link to Differentiating States">â€‹</a></h3><p>Ethanos segments the state into three tiers: active, staged, and inactive. Both active and staged states are maintained within the Over Layer, while inactive states are transferred to the Nether Layer.</p><p>Ethanos manages its operations through what are called sweep epochs, which are defined time cycles in the system, each composed of several blocks. At the start of each sweep epoch, Ethanos constructs a new empty state trie for the active states. It also references the entire set of the states from the previous epoch&#x27;s last block, known as the &quot;superblock&quot;, now designated as staged states for the current epoch. Both of these states are housed in the Over Layer.</p><p>During each transaction within an epoch, the current state trie is updated as follows: If a transaction involves a specific account, the system first checks the current epochâ€™s state trie. If the account is not found there, it then searches the previous epochâ€™s state trie. If located, the account details are seamlessly transferred to the current state trie. If the account is absent from both state tries, it indicates that the account has either been inactive in past epochs or is a completely new account. In both scenarios, Ethanos treats these as new accounts.</p><p>If an account from the last epochâ€™s trie is not involved in any transaction during the current epoch, it is then classified as inactive in the subsequent epoch and considered expired. These accounts enter a dormant status and are categorized as dormant accounts within the Nether Layer. However, being expired does not mean the account is permanently lost; a dormant account can be reactivated through restoration from the Nether Layer.</p><p>From the account&#x27;s perspective, each interaction or read operation restores two life points. As each sweep epoch passes, all accounts lose one life point. If an account goes through two consecutive sweep epochs without any life point recovery, it can no longer reside in the Over Layer.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="distinguishing-history">Distinguishing History<a href="#distinguishing-history" class="hash-link" aria-label="Direct link to Distinguishing History" title="Direct link to Distinguishing History">â€‹</a></h3><p>Ethanos employs the weak subjectivity point to purge data corresponding to the block body. This approach is straightforward but requires a mechanism to ensure the availability of the purged history. This aspect is still under research and development, with plans to leverage a light layer to facilitate this process.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="restoration-process">Restoration Process<a href="#restoration-process" class="hash-link" aria-label="Direct link to Restoration Process" title="Direct link to Restoration Process">â€‹</a></h3><p>To restore a dormant account, proof is required of the last epoch in which the account was active. This is crucial to prevent attempts to recover an account to a state before assets were transferred out in subsequent epochs. The trie structure in which the state is stored can efficiently prove whether a specific account was present within a state, as long as there is a valid root value, using a Merkle proof.</p><p>Restoration involves providing both an existence proof for the state of the last active epoch&#x27;s superblock and non-existence proofs for the epochs during which the account was inactive. Combining these proofs allows for the restoration of the account&#x27;s state to its condition in the current epoch. This process ensures that restoration is both secure and accurate, preventing unauthorized manipulations of account histories.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="dealing-with-crumb-accounts-restored-epoch">Dealing with Crumb Accounts; Restored Epoch<a href="#dealing-with-crumb-accounts-restored-epoch" class="hash-link" aria-label="Direct link to Dealing with Crumb Accounts; Restored Epoch" title="Direct link to Dealing with Crumb Accounts; Restored Epoch">â€‹</a></h4><p>As mentioned, Ethanos does not differentiate between expired accounts and accounts that never existed. In the current epoch, if an empty account receives funds and its value is initialized, the holder of the account&#x27;s private key can begin to send transactions and engage in activities using this account. An account that was previously expired but has been reinitialized and put back into use is referred to as a &quot;crumb account.&quot; The existence of crumb accounts adds complexity to the restoration process.</p><p>While we could have eliminated crumb accounts by requiring restoration to go back to the genesis epoch before activating any account, we chose not to adopt this approach for UX reasons. One significant issue with crumb accounts is that they undermine the purpose of the nonce, which exists to record the number of transactions an account has made, thereby preventing any transaction from being executed multiple times.</p><p>If nonces are reset to zero every time an account is initialized in each epoch, it could allow for the reuse of previously utilized nonces in transactions involving crumb accounts. This situation would make the network vulnerable to specific types of replay attacks. To mitigate such risks while maintaining the efficiency of the restoration process and the simplicity of nonce values, we decided to add a field called &quot;restored epoch&quot; to each account.</p><p>The &quot;restored epoch&quot; value for an account created in a specific epoch is set to <code>max(0, current epoch number - 1)</code>. This signifies that the account did not exist in the state of one epoch prior, relative to the current epoch. The &quot;restored epoch&quot; value remains constant as long as the account remains active. For example, if an account is initialized with a &quot;restored epoch&quot; value of 2 in Epoch 3 and continues to be active until Epoch 9, the &quot;restored epoch&quot; value would still be 2. This constant value helps in tracking the initial restoration point of an account throughout its active period, providing a clear reference for any processes or checks that rely on the historical status of the account.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="restoration-process-with-restored-epoch">Restoration Process with Restored Epoch<a href="#restoration-process-with-restored-epoch" class="hash-link" aria-label="Direct link to Restoration Process with Restored Epoch" title="Direct link to Restoration Process with Restored Epoch">â€‹</a></h4><p>The restoration process unfolds as follows: For the account to be restored, verification starts with a non-existence proof for the state of two epochs prior to the current one and proceeds in sequence until the last active state where an existence proof is available. A key consideration here is that the account being activated could be a crumb account. For such crumb accounts, there is no need to verify beyond the restored epoch value. Instead, proofs should be sequentially submitted up to the restored epoch minus one.</p><p>The restoration completes with the <strong>merging</strong> of the results after proofs are verified. For balances, this involves performing a sum operation, and similarly for nonces. The Restored Epoch value is determined by taking the minimum value, which indicates that the account&#x27;s balance and nonce have been verified up to that particular epoch. For instance, accounts with a restored epoch value of 0 at any point signify that their balance and nonce have been consistently preserved from the genesis to the present.</p><p>Restoration can occur in parts. For example, an account that became active in epoch 6 does not necessarily need to be restored back to epoch 0. It can continue to operate with a restored epoch value of 5, thereby simplifying the restoration process and reducing unnecessary computational effort.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="specification">Specification<a href="#specification" class="hash-link" aria-label="Direct link to Specification" title="Direct link to Specification">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sweep">Sweep<a href="#sweep" class="hash-link" aria-label="Direct link to Sweep" title="Direct link to Sweep">â€‹</a></h3><p>A configuration known as <code>SWEEP_EPOCH</code> has been introduced to determine the frequency at which inactive accounts are expired. <code>SWEEP_EPOCH</code> defines the interval for performing sweeps, with sweeps occurring every epoch as designated by this setting.</p><p>The state trie captures the activities of each account in every epoch. At each <strong>superblock</strong>, the final block of the epoch, the current state trie is frozen and a new empty state trie is created. This frozen trie is referred to as a <strong>checkpoint trie</strong>.</p><p>In the following epochs, whenever an account&#x27;s state needs updating and the account is not found in the current trie, a process is initiated to retrieve the account information from the previous checkpoint trie and integrate it into the current trie. If the account is already present in the current trie, the update is performed immediately.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="restored-epoch">Restored Epoch<a href="#restored-epoch" class="hash-link" aria-label="Direct link to Restored Epoch" title="Direct link to Restored Epoch">â€‹</a></h3><p>When an account expires, its state values are reset to empty.</p><p>A <code>restored_epoch</code> field is added to each account to record the epoch during which it was last restored. This field is crucial for determining if an account has undergone restoration previously. The initial value for <code>restored_epoch</code> is set to <code>max(0, current epoch number - 1)</code>.</p><p>The <code>restored_epoch</code> serves a function similar to that of the nonce during the restoration process by making it possible to selectively determine the point of restoration. This significantly reduces the complexity of verification as it eliminates the need to validate the state starting from the genesis block.</p><p>Furthermore, <code>restored_epoch</code> plays a vital role in contract creation. It helps ensure the uniqueness of contract addresses by preventing the regeneration of an address that has been previously used. This feature maintains the integrity and uniqueness of contract deployments on the blockchain.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="restoration-data">Restoration Data<a href="#restoration-data" class="hash-link" aria-label="Direct link to Restoration Data" title="Direct link to Restoration Data">â€‹</a></h3><p>The format for restoration data is crucial for facilitating the recovery of accounts. The required data fields for initiating a recovery transaction include:</p><p><code>[chain_id, expire_epoch, target, target_epoch, fee, fee_recipient, signature_y_parity, signature_r, signature_s]</code></p><ul><li><code>chain_id</code>: Identifies the specific blockchain network where the recovery transaction will occur.</li><li><code>expire_epoch</code>: Specifies the epoch limit for which this recovery data is valid.</li><li><code>target</code>: The account address to be recovered.</li><li><code>target_epoch</code>: The earliest epoch from which the account&#x27;s data needs to be restored.</li><li><code>fee</code>: The fee to be paid for the recovery to <code>fee_recipient</code>.</li><li><code>fee_recipient</code>: The address designated to receive the fee for facilitating the recovery.</li><li><code>signature_y_parity</code>, <code>signature_r</code>, <code>signature_s</code>: Components of the signature that authenticate the recovery request. This signature must be generated by the account responsible for paying the fee.</li></ul><p>This data structure incentivizes data providers to provide the necessary historical data for recovery while also allowing an alternative account to cover the recovery fee. This mechanism ensures that recovery transactions are both secure and financially supported.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="restoration-transaction">Restoration Transaction<a href="#restoration-transaction" class="hash-link" aria-label="Direct link to Restoration Transaction" title="Direct link to Restoration Transaction">â€‹</a></h3><p>For efficient recovery mechanisms within blockchain systems, it is essential to integrate recovery data within transactional frameworks. To facilitate this, we propose a new transaction type under <a href="https://eips.ethereum.org/EIPS/eip-2718" target="_blank" rel="noopener noreferrer">EIP-2718</a> specifically designed for account restoration.</p><p>This new type extends the existing structure of <a href="https://eips.ethereum.org/EIPS/eip-1559" target="_blank" rel="noopener noreferrer">EIP-1559</a> transactions by adding a <code>restore_data</code> field. The complete field structure is as follows:</p><p><code>[chain_id, nonce, max_priority_fee_per_gas, max_fee_per_gas, gas_limit, destination, amount, data, access_list, restore_data, signature_y_parity, signature_r, signature_s]</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="restoration-processpseudocode">Restoration Process(Pseudocode)<a href="#restoration-processpseudocode" class="hash-link" aria-label="Direct link to Restoration Process(Pseudocode)" title="Direct link to Restoration Process(Pseudocode)">â€‹</a></h3><p>Restoration process is done by following steps:</p><ol><li>Collect the account&#x27;s state proofs for each required epoch</li><li>Construct and send a restoration transaction with the collected proofs</li><li>Upon receiving the restoration transaction:<ul><li>For each proofs of epoch:<ol><li>Verify the proof</li><li>Get the state of the epoch.</li><li>Apply the state</li></ol></li></ul></li></ol><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">restore_account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> proofs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  restored_epoch </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">restored_epoch</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> proof </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> proofs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    root_hash </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> get_last_checkpoint_block_by_epoch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">restored_epoch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">state_root</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> is_accurate_merkle_proof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">root_hash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> proof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Proof is non-void proof</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        restored_account </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> extract_account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">merkle_proof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">restored_epoch </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> restored_account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">restored_epoch</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">balance </span><span class="token operator" style="color:rgb(137, 221, 255)">+=</span><span class="token plain"> restored_account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">balance</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">nonce </span><span class="token operator" style="color:rgb(137, 221, 255)">+=</span><span class="token plain"> restored_account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">nonce</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">elif</span><span class="token plain"> is_accurate_void_proof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">root_hash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> proof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Proof is void proof</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        restored_epoch </span><span class="token operator" style="color:rgb(137, 221, 255)">-=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">else</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Proof is invalid</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">raise</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Inaccurate proof&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="restoration-cost-breakdown">Restoration Cost Breakdown<a href="#restoration-cost-breakdown" class="hash-link" aria-label="Direct link to Restoration Cost Breakdown" title="Direct link to Restoration Cost Breakdown">â€‹</a></h3><p>The recovery process entails several operations such as reading or verifying data and performing decoding tasks. Each task contributes to the total cost, which is determined by the number of epochs involved in the recovery and the amount of data processed.</p><p>Here is a breakdown of the costs associated with different operations during the recovery process:</p><table><thead><tr><th>Operation</th><th>Gas</th></tr></thead><tbody><tr><td>read restoredEpoch</td><td>20</td></tr><tr><td>read nonce</td><td>20</td></tr><tr><td>read balance</td><td>20</td></tr><tr><td>Keccak256</td><td>100</td></tr><tr><td>Ecrecover</td><td>3000</td></tr><tr><td>CallValueTransfer</td><td>9000</td></tr><tr><td>CallNewAccount</td><td>25000</td></tr><tr><td>read header</td><td>800 per epoch</td></tr><tr><td>RLP decoding</td><td>1 per word</td></tr><tr><td>verifyProof</td><td>100 per epoch, 2 per word</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="cost-per-epoch">Cost Per Epoch<a href="#cost-per-epoch" class="hash-link" aria-label="Direct link to Cost Per Epoch" title="Direct link to Cost Per Epoch">â€‹</a></h4><p>For each epoch involved in the recovery process, the incurred costs include a <code>verifyProof</code> operation and a <code>read header</code> operation, each contributing to an approximate total of 900 gas per epoch. If the proof is for the existence proof, an additional <code>RLP decoding</code> operation is also necessary.</p><p>Variable costs are determined by the length of the input data, involving one <code>RLP decoding</code> and one <code>verifyProof</code> operation, both of which scale with the size of the input. These contribute an additional cost of 3 gas per word.</p><p>The formula for calculating the total recovery cost is structured as follows:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>TotalÂ RestorationÂ Cost</mtext><mo>=</mo><mn>37000</mn><mo>+</mo><mn>900</mn><mo>Ã—</mo><mrow><mi>E</mi><mi>p</mi><mi>o</mi><mi>c</mi><mi>h</mi></mrow><mo>+</mo><mn>3</mn><mo>Ã—</mo><mrow><mi>w</mi><mi>o</mi><mi>r</mi><mi>d</mi><mi>s</mi></mrow><mo>+</mo><mtext>MemoryÂ Cost</mtext></mrow><annotation encoding="application/x-tex">\text{Total Restoration Cost} = 37000 + 900\times{Epoch} + 3\times{words} + \text{Memory Cost}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord text"><span class="mord">TotalÂ RestorationÂ Cost</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">37000</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">900</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">Ep</span><span class="mord mathnormal">oc</span><span class="mord mathnormal">h</span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em">w</span><span class="mord mathnormal" style="margin-right:0.02778em">or</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord text"><span class="mord">MemoryÂ Cost</span></span></span></span></span></span></div><p>Here, 37000 gas covers the initial operations such as account creation and transaction verification, 900 gas for each epoch reflects the fixed costs per epoch, 3 gas per word accounts for variable decoding and proof verification costs, and additional memory costs.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-endgame">The Endgame<a href="#the-endgame" class="hash-link" aria-label="Direct link to The Endgame" title="Direct link to The Endgame">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="future-directions-for-contract-restoration">Future Directions for Contract Restoration<a href="#future-directions-for-contract-restoration" class="hash-link" aria-label="Direct link to Future Directions for Contract Restoration" title="Direct link to Future Directions for Contract Restoration">â€‹</a></h3><p>In Ethanos, state expiration occurs on an account-by-account basis. However, dealing with contracts poses a challenge due to the storage managed under contract accounts.</p><p>In the EVM, the storage owned by contracts can grow indefinitely in size. Handling unlimited data sizes within transaction forms to restore contracts is not feasible; it would potentially flood and paralyze the peer-to-peer network. Therefore, currently, <strong>OverProtocol has disabled the restoration functionality for contracts.</strong> Contracts must be managed in a way that prevents them from expiring.</p><p>In the ultimate vision of Ethanos, overcoming these limitations requires moving away from the traditional storage layout of the EVM. It becomes necessary to bound the size of data that accounts can own, and allow for contract-managed storages to be partially expired and restored.</p><p>In due time, a process of state and storage migration for all contracts will be implemented. This migration will occur between sweep epochs, facilitating a transition that maintains system integrity while accommodating the expansive nature of contract storage.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/overprotocol/overprotocol.github.io/edit/develop/docs/learn/key-features/layered-architecture/ethanos.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/learn/key-features/layered-architecture/overview"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Layered Architecture</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/learn/key-features/over-pos/overview"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Over PoS Overview</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-the-problem" class="table-of-contents__link toc-highlight">What is the Problem?</a></li><li><a href="#how-ethanos-works" class="table-of-contents__link toc-highlight">How Ethanos Works</a><ul><li><a href="#differentiating-states" class="table-of-contents__link toc-highlight">Differentiating States</a></li><li><a href="#distinguishing-history" class="table-of-contents__link toc-highlight">Distinguishing History</a></li><li><a href="#restoration-process" class="table-of-contents__link toc-highlight">Restoration Process</a></li></ul></li><li><a href="#specification" class="table-of-contents__link toc-highlight">Specification</a><ul><li><a href="#sweep" class="table-of-contents__link toc-highlight">Sweep</a></li><li><a href="#restored-epoch" class="table-of-contents__link toc-highlight">Restored Epoch</a></li><li><a href="#restoration-data" class="table-of-contents__link toc-highlight">Restoration Data</a></li><li><a href="#restoration-transaction" class="table-of-contents__link toc-highlight">Restoration Transaction</a></li><li><a href="#restoration-processpseudocode" class="table-of-contents__link toc-highlight">Restoration Process(Pseudocode)</a></li><li><a href="#restoration-cost-breakdown" class="table-of-contents__link toc-highlight">Restoration Cost Breakdown</a></li></ul></li><li><a href="#the-endgame" class="table-of-contents__link toc-highlight">The Endgame</a><ul><li><a href="#future-directions-for-contract-restoration" class="table-of-contents__link toc-highlight">Future Directions for Contract Restoration</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://x.com/overprotocol" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/overprotocol" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2024 OverProtocol</div></div></div></footer></div>
<script src="/assets/js/runtime~main.8273acfe.js"></script>
<script src="/assets/js/main.a4e6c244.js"></script>
</body>
</html>